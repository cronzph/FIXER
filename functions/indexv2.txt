const { onValueCreated, onValueUpdated } = require('firebase-functions/v2/database');
const { onSchedule } = require('firebase-functions/v2/scheduler');
const { onCall } = require('firebase-functions/v2/https');
const admin = require('firebase-admin');

admin.initializeApp();

/**
 * Cloud Function to send notification when new report is created
 */
exports.onNewReport = onValueCreated({
  ref: '/maintenance_reports/{reportId}',
  region: 'us-central1'
}, async (event) => {
  const reportId = event.params.reportId;
  const reportData = event.data.val();

  console.log('New report created:', reportId);

  try {
    const title = reportData.title || 'New Report';
    const priority = reportData.priority || 'medium';
    const reportedBy = reportData.reportedBy || 'Someone';

    const adminsSnapshot = await admin.database()
      .ref('users')
      .orderByChild('role')
      .equalTo('ADMIN')
      .once('value');

    const tokens = [];
    const notificationPromises = [];

    adminsSnapshot.forEach((adminSnapshot) => {
      const adminId = adminSnapshot.key;
      const adminData = adminSnapshot.val();

      if (adminData.roleActive === true) {
        notificationPromises.push(
          admin.database()
            .ref(`user_tokens/${adminId}`)
            .once('value')
            .then((tokenSnapshot) => {
              const token = tokenSnapshot.val()?.token;
              if (token) tokens.push(token);
            })
        );

        const notificationData = {
          title: 'New Maintenance Report',
          body: `${reportedBy} reported: ${title} (${priority.toUpperCase()})`,
          type: 'new_report',
          reportId,
          priority,
          timestamp: Date.now(),
          read: false
        };

        admin.database()
          .ref(`user_notifications/${adminId}`)
          .push(notificationData);
      }
    });

    await Promise.all(notificationPromises);

    if (tokens.length === 0) {
      console.log('No admin tokens found');
      return null;
    }

    const payload = {
      notification: {
        title: 'New Maintenance Report',
        body: `${reportedBy} reported: ${title} (${priority.toUpperCase()})`,
        sound: 'default',
      },
      data: {
        type: 'new_report',
        reportId,
        priority,
        click_action: 'FLUTTER_NOTIFICATION_CLICK'
      }
    };

    const response = await admin.messaging().sendToDevice(tokens, payload);
    console.log('Notifications sent:', response.successCount, 'success,', response.failureCount, 'failed');

    return response;
  } catch (error) {
    console.error('Error sending notification:', error);
    return null;
  }
});

/**
 * Cloud Function to send notification when report status changes
 */
exports.onReportStatusChange = onValueUpdated({
  ref: '/maintenance_reports/{reportId}/status',
  region: 'us-central1'
}, async (event) => {
  const reportId = event.params.reportId;
  const newStatus = event.data.after.val();
  const oldStatus = event.data.before.val();

  if (newStatus === oldStatus) return null;

  console.log(`Report ${reportId} status changed from ${oldStatus} to ${newStatus}`);

  try {
    const reportSnapshot = await admin.database()
      .ref(`maintenance_reports/${reportId}`)
      .once('value');

    const reportData = reportSnapshot.val();
    if (!reportData) return null;

    const title = reportData.title || 'Report';
    const reporterUid = reportData.reportedByUid;
    if (!reporterUid) return null;

    const tokenSnapshot = await admin.database()
      .ref(`user_tokens/${reporterUid}`)
      .once('value');

    const token = tokenSnapshot.val()?.token;
    if (!token) return null;

    const notificationData = {
      title: 'Report Status Update',
      body: `Your report '${title}' is now ${newStatus.toUpperCase()}`,
      type: 'status_change',
      reportId,
      priority: (newStatus === 'completed' || newStatus === 'rejected') ? 'high' : 'medium',
      timestamp: Date.now(),
      read: false
    };

    await admin.database()
      .ref(`user_notifications/${reporterUid}`)
      .push(notificationData);

    const payload = {
      notification: {
        title: 'Report Status Update',
        body: `Your report '${title}' is now ${newStatus.toUpperCase()}`,
        sound: 'default',
      },
      data: {
        type: 'status_change',
        reportId,
        status: newStatus,
        click_action: 'FLUTTER_NOTIFICATION_CLICK'
      }
    };

    const response = await admin.messaging().sendToDevice(token, payload);
    console.log('Status change notification sent:', response);

    return response;
  } catch (error) {
    console.error('Error sending status change notification:', error);
    return null;
  }
});

/**
 * Cloud Function to notify technician when assigned
 */
exports.onTaskAssigned = onValueCreated({
  ref: '/maintenance_reports/{reportId}/assignedTo',
  region: 'us-central1'
}, async (event) => {
  const reportId = event.params.reportId;
  const technicianEmail = event.data.val();

  if (!technicianEmail) return null;

  console.log(`Task ${reportId} assigned to ${technicianEmail}`);

  try {
    const reportSnapshot = await admin.database()
      .ref(`maintenance_reports/${reportId}`)
      .once('value');

    const reportData = reportSnapshot.val();
    const title = reportData.title || 'Maintenance Task';
    const scheduledDate = reportData.scheduledDate || '';

    const usersSnapshot = await admin.database()
      .ref('users')
      .orderByChild('email')
      .equalTo(technicianEmail)
      .once('value');

    let technicianUid = null;
    usersSnapshot.forEach((userSnapshot) => {
      technicianUid = userSnapshot.key;
    });

    if (!technicianUid) return null;

    const tokenSnapshot = await admin.database()
      .ref(`user_tokens/${technicianUid}`)
      .once('value');

    const token = tokenSnapshot.val()?.token;
    if (!token) return null;

    let body = `You have been assigned: ${title}`;
    if (scheduledDate) body += ` (Scheduled: ${scheduledDate})`;

    const notificationData = {
      title: 'New Task Assigned',
      body,
      type: 'task_assigned',
      reportId,
      priority: 'high',
      timestamp: Date.now(),
      read: false
    };

    await admin.database()
      .ref(`user_notifications/${technicianUid}`)
      .push(notificationData);

    const payload = {
      notification: {
        title: 'New Task Assigned',
        body,
        sound: 'default',
      },
      data: {
        type: 'task_assigned',
        reportId,
        click_action: 'FLUTTER_NOTIFICATION_CLICK'
      }
    };

    const response = await admin.messaging().sendToDevice(token, payload);
    console.log('Task assignment notification sent:', response);

    return response;
  } catch (error) {
    console.error('Error sending task assignment notification:', error);
    return null;
  }
});

/**
 * Cloud Function to notify when task is completed
 */
exports.onTaskCompleted = onValueCreated({
  ref: '/maintenance_reports/{reportId}/completedAt',
  region: 'us-central1'
}, async (event) => {
  const reportId = event.params.reportId;
  const completedAt = event.data.val();

  if (!completedAt) return null;

  console.log(`Task ${reportId} completed`);

  try {
    const reportSnapshot = await admin.database()
      .ref(`maintenance_reports/${reportId}`)
      .once('value');

    const reportData = reportSnapshot.val();
    const title = reportData.title || 'Task';
    const completedBy = reportData.completedBy || 'Technician';
    const reporterUid = reportData.reportedByUid;

    const adminsSnapshot = await admin.database()
      .ref('users')
      .orderByChild('role')
      .equalTo('ADMIN')
      .once('value');

    const adminTokenPromises = [];

    adminsSnapshot.forEach((adminSnapshot) => {
      const adminId = adminSnapshot.key;
      const adminData = adminSnapshot.val();

      if (adminData.roleActive === true) {
        adminTokenPromises.push(
          admin.database()
            .ref(`user_tokens/${adminId}`)
            .once('value')
            .then(async (tokenSnapshot) => {
              const token = tokenSnapshot.val()?.token;

              const notificationData = {
                title: 'Task Completed',
                body: `${completedBy} completed: ${title}`,
                type: 'report_completed',
                reportId,
                priority: 'medium',
                timestamp: Date.now(),
                read: false
              };

              await admin.database()
                .ref(`user_notifications/${adminId}`)
                .push(notificationData);

              if (token) {
                const payload = {
                  notification: {
                    title: 'Task Completed',
                    body: `${completedBy} completed: ${title}`,
                    sound: 'default',
                  },
                  data: {
                    type: 'report_completed',
                    reportId,
                    click_action: 'FLUTTER_NOTIFICATION_CLICK'
                  }
                };

                return admin.messaging().sendToDevice(token, payload);
              }
            })
        );
      }
    });

    if (reporterUid) {
      const tokenSnapshot = await admin.database()
        .ref(`user_tokens/${reporterUid}`)
        .once('value');

      const token = tokenSnapshot.val()?.token;

      const notificationData = {
        title: '✅ Your Report is Complete',
        body: `Your maintenance request '${title}' has been completed by ${completedBy}`,
        type: 'user_report_completed',
        reportId,
        priority: 'high',
        timestamp: Date.now(),
        read: false
      };

      await admin.database()
        .ref(`user_notifications/${reporterUid}`)
        .push(notificationData);

      if (token) {
        const payload = {
          notification: {
            title: '✅ Your Report is Complete',
            body: `Your maintenance request '${title}' has been completed`,
            sound: 'default',
          },
          data: {
            type: 'user_report_completed',
            reportId,
            click_action: 'FLUTTER_NOTIFICATION_CLICK'
          }
        };

        adminTokenPromises.push(admin.messaging().sendToDevice(token, payload));
      }
    }

    await Promise.all(adminTokenPromises);
    console.log('Task completion notifications sent');
    return null;
  } catch (error) {
    console.error('Error sending task completion notification:', error);
    return null;
  }
});